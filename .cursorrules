# Face Mosaic Local - Cursor Rules

## 프로젝트 개요

**Face Mosaic Local** - OpenCV 기반 로컬 얼굴 모자이크 처리 프로그램
- 완전 무료, 프라이버시 보장, 오프라인 동작
- Python 3.9+, OpenCV 4.8+, NumPy, Pillow, tqdm

## 프로젝트 구조

```
face-mosaic-local/
├── src/
│   ├── main.py          # CLI 진입점
│   ├── detector.py      # 얼굴 감지 (Haar/DNN)
│   ├── mosaic.py        # 모자이크/블러 처리
│   ├── processor.py     # 일괄 처리 로직
│   └── utils.py         # 유틸리티 함수
├── models/              # DNN 모델 파일
├── tests/               # 단위 테스트
├── input/               # 테스트 입력 (gitignore)
└── output/              # 처리 결과 (gitignore)
```

## 코드 스타일

### Python 코딩 규칙
- **타입 힌트 필수**: 모든 함수 파라미터와 반환값에 타입 힌트 추가
- **Docstring 필수**: 모든 public 함수/클래스에 Google 스타일 docstring
- **에러 핸들링**: try-except로 명시적 예외 처리, 친절한 에러 메시지
- **로깅**: `logging` 모듈 사용, 파일 + 콘솔 핸들러
- **주석**: 복잡한 로직에만 한글 주석 추가

### 예시
```python
from typing import List, Tuple, Optional
import cv2
import numpy as np

def detect_faces(image: np.ndarray, confidence: float = 0.5) -> List[Tuple[int, int, int, int]]:
    """
    이미지에서 얼굴을 감지합니다.
    
    Args:
        image: 입력 이미지 (BGR 형식)
        confidence: 신뢰도 임계값 (기본값: 0.5)
    
    Returns:
        얼굴 바운딩 박스 리스트 [(x, y, width, height), ...]
    """
    # 구현...
    pass
```

## 모듈별 가이드라인

### detector.py
- **베이스 클래스**: `FaceDetector` 추상 클래스 정의
- **구현체**: `HaarCascadeDetector`, `DNNDetector`
- **팩토리 함수**: `get_detector(type: str) -> FaceDetector`
- **반환 형식**: `List[Tuple[int, int, int, int]]` (x, y, w, h)
- **DNN 모델 경로**: `models/deploy.prototxt`, `models/res10_300x300_ssd_iter_140000.caffemodel`

### mosaic.py
- **모자이크**: `apply_mosaic(image, bbox, block_size)` - 영역 추출 → 축소 → 확대
- **블러**: `apply_blur(image, bbox, kernel_size)` - Gaussian blur
- **통합**: `process_faces(image, bboxes, method, **kwargs)` - 다중 얼굴 처리
- **경계 처리**: 이미지 범위 벗어나는 경우 자동 클리핑

### processor.py
- **클래스**: `FaceMosaicProcessor`
- **메서드**: `process_image()`, `process_folder()`
- **진행률**: `tqdm` 사용 필수
- **통계**: 성공/실패/스킵 수집, 처리 시간 측정

### utils.py
- **파일 유틸**: `get_image_files(folder, recursive=False)` - 지원 확장자 필터링
- **이미지 I/O**: `load_image()`, `save_image()` - EXIF 메타데이터 보존
- **로깅**: `setup_logger()` - 파일 + 콘솔 핸들러 설정

### main.py
- **argparse**: CLI 인터페이스
- **필수 인자**: `--input` (입력 폴더)
- **선택 인자**: `--output` (기본값: ./output), `--detector` (haar/dnn), `--mosaic-size` (기본값: 15), `--method` (mosaic/blur), `--confidence` (기본값: 0.5)
- **유효성 검사**: 입력 폴더 존재, 출력 폴더 자동 생성, 모델 파일 확인

## 성능 요구사항

- **처리 속도**: 1초/장 (1080p 기준)
- **메모리 사용**: < 500MB
- **감지 정확도**: > 90% (정면 얼굴)
- **지원 이미지 크기**: 최대 8K (7680x4320)

## 에러 핸들링

### 필수 체크
- 입력 폴더 존재 확인
- 출력 폴더 자동 생성 (없으면)
- 모델 파일 존재 확인 (DNN 사용 시)
- 이미지 파일 형식 검증
- 메모리 부족 예외 처리

### 에러 메시지
- 친절하고 명확한 한글 메시지
- 해결 방법 제시
- 로그 파일에 상세 정보 기록

## 테스트

### 단위 테스트
- `tests/test_detector.py`: 얼굴 감지 테스트
- `tests/test_mosaic.py`: 모자이크/블러 테스트
- `tests/test_processor.py`: 일괄 처리 테스트

### 테스트 케이스
- 얼굴 없는 이미지
- 다중 얼굴 이미지
- 큰 이미지 (4K+)
- 회전된 이미지
- 잘못된 파일 형식

## 의존성 관리

### 필수 라이브러리
```
opencv-python>=4.8.0
numpy>=1.24.0
Pillow>=10.0.0
tqdm>=4.65.0
```

### requirements.txt 형식
- 버전 고정 (==) 사용 금지, 최소 버전 (>=) 사용
- 주석으로 용도 명시

## 파일 네이밍

- **모듈**: snake_case (`detector.py`, `face_mosaic.py`)
- **클래스**: PascalCase (`FaceDetector`, `FaceMosaicProcessor`)
- **함수/변수**: snake_case (`detect_faces`, `mosaic_size`)
- **상수**: UPPER_SNAKE_CASE (`DEFAULT_CONFIDENCE`, `SUPPORTED_FORMATS`)

## Git 규칙

### .gitignore
- `venv/`, `__pycache__/`, `*.pyc`
- `input/`, `output/` (테스트 데이터)
- `*.log`, `.pytest_cache/`
- `models/*.caffemodel` (큰 파일, 다운로드 스크립트 제공)

### 커밋 메시지
- 간결하고 명확하게
- 예: "feat: DNN 감지기 구현", "fix: 모자이크 경계 처리 버그 수정"

## 주의사항

### 금지 사항
- 하드코딩된 경로 (상대 경로 또는 설정 파일 사용)
- print() 사용 (로깅 모듈 사용)
- 전역 변수 남용
- 예외 무시 (pass만 사용 금지)

### 권장 사항
- 타입 힌트로 IDE 자동완성 향상
- Docstring으로 API 문서 자동 생성 가능
- 설정값은 상수로 정의
- 모듈화된 구조 유지

## 참고 자료

- [OpenCV Face Detection](https://docs.opencv.org/4.x/db/d28/tutorial_cascade_classifier.html)
- [OpenCV DNN Module](https://docs.opencv.org/4.x/d2/d58/tutorial_table_of_content_dnn.html)
- [DNN Face Detector Model](https://github.com/opencv/opencv/tree/master/samples/dnn/face_detector)
